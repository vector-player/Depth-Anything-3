# üìê estimate_k_matrix.py - K-Matrix Extraction Tool

A command-line tool to extract camera intrinsics (K-matrix) from Depth-Anything-3 NPZ output files.

## üìã Overview

This script extracts camera intrinsics (K-matrix) from NPZ files generated by DA3 CLI commands (`da3 image`, `da3 auto`, `da3 images`) when using the `--export-format mini_npz` option.

The K-matrix is a 3√ó3 camera intrinsic matrix that contains:
- **Focal lengths** (fx, fy) in pixels
- **Principal point** (cx, cy) in pixels

## üöÄ Quick Start

### Prerequisites

1. **NPZ file from DA3**: First, generate an NPZ file using DA3 CLI:
   ```bash
   da3 image path/to/image.jpg --export-dir ./output --export-format mini_npz
   ```

2. **Python dependencies**: The script requires:
   - Python 3.6+
   - NumPy

### Basic Usage

```bash
# Extract K-matrix from NPZ file (first image)
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output K.txt
```

## üìñ Usage Examples

### Example 1: Extract K-Matrix for First Image

```bash
# Step 1: Generate NPZ file with DA3
da3 image photo.jpg --export-dir ./output --export-format mini_npz

# Step 2: Extract K-matrix
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output K.txt
```

**Output:**
```
Loading NPZ file: ./output/exports/mini_npz/results.npz
Found intrinsics with shape: (1, 3, 3)

K-matrix for image 0:
  fx (focal length X): 1234.567890 pixels
  fy (focal length Y): 1234.567890 pixels
  cx (principal point X): 640.000000 pixels
  cy (principal point Y): 360.000000 pixels

Saving K-matrix to: K.txt
‚úì K-matrix saved successfully!

K-matrix (3x3):
[[1234.567890     0.000000   640.000000]
 [    0.000000  1234.567890   360.000000]
 [    0.000000     0.000000     1.000000]]
```

### Example 2: Extract K-Matrix for Specific Image

When processing multiple images, extract a specific image's K-matrix:

```bash
# Process multiple images
da3 images ./dataset/ --export-dir ./output --export-format mini_npz

# Extract K-matrix for the 5th image (index 4)
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output K_image_5.txt \
    --image-index 4
```

### Example 3: Batch Extract All K-Matrices

Extract all K-matrices from a batch processing result:

```bash
# Process directory of images
da3 auto ./images/ --export-dir ./output --export-format mini_npz

# Extract all K-matrices
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output-dir ./K_matrices \
    --batch
```

**Output:**
```
Loading NPZ file: ./output/exports/mini_npz/results.npz
Found 50 K-matrices in NPZ file
‚úì Saved K-matrix 0 to ./K_matrices/K_0000.txt
‚úì Saved K-matrix 1 to ./K_matrices/K_0001.txt
...
‚úì Saved K-matrix 49 to ./K_matrices/K_0049.txt

============================================================
SUCCESS: Extracted 50/50 K-matrices
Output directory: ./K_matrices
============================================================
```

## ‚öôÔ∏è Command-Line Options

### Required Arguments

- `--npz NPZ_PATH`: Path to NPZ file containing DA3 results
  - Example: `./output/exports/mini_npz/results.npz`

### Optional Arguments

- `--output OUTPUT_PATH`: Path to output K-matrix file (for single extraction)
  - Required when not using `--batch`
  - Example: `K.txt`

- `--output-dir OUTPUT_DIR`: Directory to save K-matrices (for batch extraction)
  - Required when using `--batch`
  - Example: `./K_matrices`

- `--image-index INDEX`: Index of the image to extract (default: 0)
  - Only used in single extraction mode
  - Example: `--image-index 5` (extracts 6th image, 0-indexed)

- `--batch`: Extract all K-matrices from the NPZ file
  - Requires `--output-dir` to be specified
  - Saves files as `K_0000.txt`, `K_0001.txt`, etc.

- `-h, --help`: Show help message and exit

## üìÑ Output Format

The K-matrix is saved as a space-separated text file with 3 rows and 3 columns:

```
fx    0    cx
0     fy   cy
0     0    1
```

**Example K.txt:**
```
1234.567890     0.000000   640.000000
    0.000000  1234.567890   360.000000
    0.000000     0.000000     1.000000
```

### Loading K-Matrix in Python

```python
import numpy as np

# Load K-matrix from file
K = np.loadtxt('K.txt')
print(f"K-matrix shape: {K.shape}")  # (3, 3)

# Access parameters
fx = K[0, 0]  # Focal length X
fy = K[1, 1]  # Focal length Y
cx = K[0, 2]  # Principal point X
cy = K[1, 2]  # Principal point Y
```

## üí° Use Cases

### 1. 3D Reconstruction

Use K-matrix with depth maps to generate accurate point clouds:

```python
import numpy as np
from depth_anything_3.api import DepthAnything3

# Load K-matrix
K = np.loadtxt('K.txt')

# Get depth map from DA3
prediction = model.inference(image=["image.jpg"])
depth = prediction.depth[0]

# Generate point cloud
h, w = depth.shape
u, v = np.meshgrid(np.arange(w), np.arange(h))
points = np.stack([u, v, np.ones_like(u)], axis=-1)
points = points @ np.linalg.inv(K).T
points = points * depth[..., np.newaxis]
```

### 2. SLAM/Tracking Systems

Provide camera intrinsics for visual SLAM systems:

```python
import numpy as np
from pysrt3d import Tracker

# Load K-matrix
K = np.loadtxt('K.txt')

# Initialize tracker
h, w = 1080, 1920  # Image dimensions
tracker = Tracker(imwidth=w, imheight=h, K=K)
```

### 3. Camera Calibration

Estimate camera parameters when calibration patterns are unavailable:

```bash
# Process multiple images from different angles
da3 images ./calibration_images/ --export-dir ./output --export-format mini_npz

# Extract all K-matrices
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output-dir ./calibration_results \
    --batch

# Analyze consistency across images
python -c "
import numpy as np
import glob

K_files = sorted(glob.glob('./calibration_results/K_*.txt'))
K_matrices = [np.loadtxt(f) for f in K_files]

# Calculate average K-matrix
K_avg = np.mean(K_matrices, axis=0)
print('Average K-matrix:')
print(K_avg)
"
```

### 4. Multi-View Stereo

Use intrinsics for pose-conditioned depth estimation:

```python
import numpy as np
from depth_anything_3.api import DepthAnything3

# Load K-matrix
K = np.loadtxt('K.txt')

# Use with pose-conditioned depth estimation
model = DepthAnything3.from_pretrained("depth-anything/DA3-LARGE-1.1")
prediction = model.inference(
    image=["img1.jpg", "img2.jpg"],
    intrinsics=K[np.newaxis, :, :],  # Add batch dimension
    align_to_input_ext_scale=True
)
```

## üîç Understanding the K-Matrix

The K-matrix (camera intrinsic matrix) is a 3√ó3 matrix that describes the internal camera parameters:

```
K = [[fx,  0, cx],
     [0,  fy, cy],
     [0,   0,  1]]
```

### Parameters

- **fx, fy**: Focal lengths in pixels
  - Typically similar values for most cameras
  - Related to the camera's field of view
  - Higher values = narrower field of view (telephoto)
  - Lower values = wider field of view (wide-angle)

- **cx, cy**: Principal point coordinates (image center) in pixels
  - Usually near the center of the image
  - For an image of size W√óH: cx ‚âà W/2, cy ‚âà H/2
  - Represents the optical center projection

### Typical Values

For a 1920√ó1080 image:
- fx, fy: ~1000-2000 pixels (depends on camera)
- cx: ~960 pixels (W/2)
- cy: ~540 pixels (H/2)

## ‚ùì Troubleshooting

### Error: NPZ file not found

**Problem:** The script cannot find the NPZ file.

**Solution:**
- Check that you've run DA3 CLI with `--export-format mini_npz`
- Verify the path to the NPZ file is correct
- The NPZ file is typically located at: `./output/exports/mini_npz/results.npz`

### Error: 'intrinsics' not found in NPZ file

**Problem:** The NPZ file doesn't contain intrinsics data.

**Solution:**
- Ensure you used `--export-format mini_npz` (or `npz`) when running DA3
- The `glb` format doesn't include separate intrinsics files
- Re-run DA3 with the correct export format:
  ```bash
  da3 image photo.jpg --export-dir ./output --export-format mini_npz
  ```

### Error: Image index out of range

**Problem:** The specified image index is greater than the number of images.

**Solution:**
- Check how many images are in the NPZ file
- Use `--image-index` with a valid index (0 to N-1)
- Or use `--batch` to extract all K-matrices

### K-Matrix values seem incorrect

**Problem:** The K-matrix values don't match expected camera parameters.

**Possible causes:**
- Image resolution mismatch (K-matrix is in pixels, depends on image size)
- Different processing resolution used in DA3
- Camera model differences

**Solution:**
- Verify the image dimensions match the expected resolution
- Check the `--process-res` parameter used in DA3
- K-matrix values are relative to the processed image size, not original size

## üîó Related Resources

- **DA3 CLI Documentation**: See `Usage_guide.md` for CLI command details
- **DA3 Python API**: See `docs/API.md` for Python API usage
- **K-Matrix Use Cases**: See Example 9 in `Usage_guide.md`

## üìù Notes

- The K-matrix is estimated automatically by DA3 during inference
- Values are in pixels and depend on the image resolution
- For best results, use images with good lighting and clear features
- The estimated K-matrix may vary slightly between images from the same camera
- For batch processing, consider averaging K-matrices for consistency

---

**Last Updated**: Based on Depth-Anything-3 estimate_k_matrix.py script
