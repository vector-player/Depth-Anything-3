# üìê estimate_k_matrix.py - K-Matrix Extraction Tool

A command-line tool to extract camera intrinsics (K-matrix) from Depth-Anything-3.

## üìã Overview

This script can extract camera intrinsics (K-matrix) in two ways:
1. **Direct image processing**: Process images directly using DA3 API (one-command solution)
2. **NPZ extraction**: Extract from NPZ files generated by DA3 CLI commands

The K-matrix is a 3√ó3 camera intrinsic matrix that contains:
- **Focal lengths** (fx, fy) in pixels
- **Principal point** (cx, cy) in pixels

## üöÄ Quick Start

### Prerequisites

**For direct image processing (`--image` mode):**
- Python 3.6+
- NumPy
- PyTorch
- Depth-Anything-3 package installed

**For NPZ extraction (`--npz` mode):**
- Python 3.6+
- NumPy
- NPZ file generated by DA3 CLI

### Basic Usage

**Method 1: Process image directly (one command)**
```bash
# Process image and extract K-matrix in one command
python lib/estimate_k_matrix.py --image photo.jpg --output K.txt
```

**Method 2: Extract from NPZ file (two-step: da3 CLI + this script)**
```bash
# Step 1: Generate NPZ file with DA3 CLI
da3 image photo.jpg --export-dir ./output --export-format mini_npz

# Step 2: Extract K-matrix from NPZ file
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output K.txt
```

## üìñ Usage Examples

### Example 1: Process Image Directly (One Command) ‚≠ê NEW

Process an image directly without needing to run DA3 CLI first:

```bash
# Single command - process image and extract K-matrix
python lib/estimate_k_matrix.py --image photo.jpg --output K.txt
```

**Output:**
```
Loading image: photo.jpg
Image size: 1920 x 1080 pixels
Initializing DA3 model: depth-anything/DA3-LARGE-1.1
Model loaded successfully on cuda
Processing image with DA3...

K-matrix for image:
  fx (focal length X): 1234.567890 pixels
  fy (focal length Y): 1234.567890 pixels
  cx (principal point X): 960.000000 pixels
  cy (principal point Y): 540.000000 pixels

Saving K-matrix to: K.txt
‚úì K-matrix saved successfully!
```

### Example 2: Extract K-Matrix from NPZ File

```bash
# Step 1: Generate NPZ file with DA3 CLI
da3 image photo.jpg --export-dir ./output --export-format mini_npz

# Step 2: Extract K-matrix
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output K.txt
```

**Output:**
```
Loading NPZ file: ./output/exports/mini_npz/results.npz
Found intrinsics with shape: (1, 3, 3)

K-matrix for image 0:
  fx (focal length X): 1234.567890 pixels
  fy (focal length Y): 1234.567890 pixels
  cx (principal point X): 640.000000 pixels
  cy (principal point Y): 360.000000 pixels

Saving K-matrix to: K.txt
‚úì K-matrix saved successfully!

K-matrix (3x3):
[[1234.567890     0.000000   640.000000]
 [    0.000000  1234.567890   360.000000]
 [    0.000000     0.000000     1.000000]]
```

### Example 3: Process Multiple Images Directly ‚≠ê NEW

Process multiple images in a directory (model loaded once, reused for efficiency):

```bash
# Process all images in directory and extract K-matrices
python lib/estimate_k_matrix.py \
    --image-dir ./images/ \
    --output-dir ./K_matrices \
    --batch
```

**Output:**
```
Found 50 images to process
Initializing DA3 model: depth-anything/DA3-LARGE-1.1
Model loaded successfully on cuda

[1/50] Processing: image_001.jpg
  ‚úì Saved K-matrix to ./K_matrices/K_0000.txt
[2/50] Processing: image_002.jpg
  ‚úì Saved K-matrix to ./K_matrices/K_0001.txt
...
[50/50] Processing: image_050.jpg
  ‚úì Saved K-matrix to ./K_matrices/K_0049.txt

============================================================
SUCCESS: Extracted 50/50 K-matrices
Output directory: ./K_matrices
============================================================
```

### Example 4: Extract K-Matrix for Specific Image from NPZ

When processing multiple images, extract a specific image's K-matrix:

```bash
# Process multiple images
da3 images ./dataset/ --export-dir ./output --export-format mini_npz

# Extract K-matrix for the 5th image (index 4)
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output K_image_5.txt \
    --image-index 4
```

### Example 5: Batch Extract All K-Matrices from NPZ

Extract all K-matrices from a batch processing result:

```bash
# Process directory of images
da3 auto ./images/ --export-dir ./output --export-format mini_npz

# Extract all K-matrices
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output-dir ./K_matrices \
    --batch
```

**Output:**
```
Loading NPZ file: ./output/exports/mini_npz/results.npz
Found 50 K-matrices in NPZ file
‚úì Saved K-matrix 0 to ./K_matrices/K_0000.txt
‚úì Saved K-matrix 1 to ./K_matrices/K_0001.txt
...
‚úì Saved K-matrix 49 to ./K_matrices/K_0049.txt

============================================================
SUCCESS: Extracted 50/50 K-matrices
Output directory: ./K_matrices
============================================================
```

## ‚öôÔ∏è Command-Line Options

### Input Source (Required - Choose One)

- `--image IMAGE_PATH`: Path to input image file (for direct processing)
  - Example: `photo.jpg`
  - Processes image directly using DA3 API

- `--image-dir IMAGE_DIR`: Directory containing images to process
  - Example: `./images/`
  - Requires `--batch` flag
  - Processes all images in directory

- `--npz NPZ_PATH`: Path to NPZ file containing DA3 results
  - Example: `./output/exports/mini_npz/results.npz`
  - Extracts K-matrix from pre-generated NPZ file

### Output Options

- `--output OUTPUT_PATH`: Path to output K-matrix file (for single extraction)
  - Required when using `--image` or `--npz` without `--batch`
  - Example: `K.txt`

- `--output-dir OUTPUT_DIR`: Directory to save K-matrices (for batch extraction)
  - Required when using `--batch` or `--image-dir`
  - Example: `./K_matrices`
  - Saves files as `K_0000.txt`, `K_0001.txt`, etc.

### Processing Options (for `--image` mode)

- `--model MODEL_NAME`: DA3 model name or HuggingFace path
  - Default: `depth-anything/DA3-LARGE-1.1`
  - Examples: `depth-anything/DA3-BASE`, `depth-anything/DA3-GIANT-1.1`

- `--device {cuda,cpu}`: Device to use for processing
  - Default: `cuda`
  - Use `cpu` if GPU is not available

- `--process-res RESOLUTION`: Processing resolution
  - Default: `504`
  - Higher values improve quality but increase computation time

### NPZ Extraction Options (for `--npz` mode)

- `--image-index INDEX`: Index of the image to extract (default: 0)
  - Only used in single extraction mode (without `--batch`)
  - Example: `--image-index 5` (extracts 6th image, 0-indexed)

- `--batch`: Extract all K-matrices
  - Required when using `--image-dir`
  - Optional when using `--npz` (extracts all K-matrices from NPZ)
  - Requires `--output-dir` to be specified

### General Options

- `-h, --help`: Show help message and exit

## üìÑ Output Format

The K-matrix is saved as a space-separated text file with 3 rows and 3 columns:

```
fx    0    cx
0     fy   cy
0     0    1
```

**Example K.txt:**
```
1234.567890     0.000000   640.000000
    0.000000  1234.567890   360.000000
    0.000000     0.000000     1.000000
```

### Loading K-Matrix in Python

```python
import numpy as np

# Load K-matrix from file
K = np.loadtxt('K.txt')
print(f"K-matrix shape: {K.shape}")  # (3, 3)

# Access parameters
fx = K[0, 0]  # Focal length X
fy = K[1, 1]  # Focal length Y
cx = K[0, 2]  # Principal point X
cy = K[1, 2]  # Principal point Y
```

## üí° Use Cases

### 1. 3D Reconstruction

Use K-matrix with depth maps to generate accurate point clouds:

```python
import numpy as np
from depth_anything_3.api import DepthAnything3

# Load K-matrix
K = np.loadtxt('K.txt')

# Get depth map from DA3
prediction = model.inference(image=["image.jpg"])
depth = prediction.depth[0]

# Generate point cloud
h, w = depth.shape
u, v = np.meshgrid(np.arange(w), np.arange(h))
points = np.stack([u, v, np.ones_like(u)], axis=-1)
points = points @ np.linalg.inv(K).T
points = points * depth[..., np.newaxis]
```

### 2. SLAM/Tracking Systems

Provide camera intrinsics for visual SLAM systems:

```python
import numpy as np
from pysrt3d import Tracker

# Load K-matrix
K = np.loadtxt('K.txt')

# Initialize tracker
h, w = 1080, 1920  # Image dimensions
tracker = Tracker(imwidth=w, imheight=h, K=K)
```

### 3. Camera Calibration

Estimate camera parameters when calibration patterns are unavailable:

```bash
# Process multiple images from different angles
da3 images ./calibration_images/ --export-dir ./output --export-format mini_npz

# Extract all K-matrices
python lib/estimate_k_matrix.py \
    --npz ./output/exports/mini_npz/results.npz \
    --output-dir ./calibration_results \
    --batch

# Analyze consistency across images
python -c "
import numpy as np
import glob

K_files = sorted(glob.glob('./calibration_results/K_*.txt'))
K_matrices = [np.loadtxt(f) for f in K_files]

# Calculate average K-matrix
K_avg = np.mean(K_matrices, axis=0)
print('Average K-matrix:')
print(K_avg)
"
```

### 4. Multi-View Stereo

Use intrinsics for pose-conditioned depth estimation:

```python
import numpy as np
from depth_anything_3.api import DepthAnything3

# Load K-matrix
K = np.loadtxt('K.txt')

# Use with pose-conditioned depth estimation
model = DepthAnything3.from_pretrained("depth-anything/DA3-LARGE-1.1")
prediction = model.inference(
    image=["img1.jpg", "img2.jpg"],
    intrinsics=K[np.newaxis, :, :],  # Add batch dimension
    align_to_input_ext_scale=True
)
```

## üîç Understanding the K-Matrix

The K-matrix (camera intrinsic matrix) is a 3√ó3 matrix that describes the internal camera parameters:

```
K = [[fx,  0, cx],
     [0,  fy, cy],
     [0,   0,  1]]
```

### Parameters

- **fx, fy**: Focal lengths in pixels
  - Typically similar values for most cameras
  - Related to the camera's field of view
  - Higher values = narrower field of view (telephoto)
  - Lower values = wider field of view (wide-angle)

- **cx, cy**: Principal point coordinates (image center) in pixels
  - Usually near the center of the image
  - For an image of size W√óH: cx ‚âà W/2, cy ‚âà H/2
  - Represents the optical center projection

### Typical Values

For a 1920√ó1080 image:
- fx, fy: ~1000-2000 pixels (depends on camera)
- cx: ~960 pixels (W/2)
- cy: ~540 pixels (H/2)

## üîÑ Processing Modes Comparison

The script supports two processing modes:

| Feature | Direct Image Processing (`--image`) | NPZ Extraction (`--npz`) |
|---------|-------------------------------------|--------------------------|
| **Workflow** | One command | Two-step (DA3 CLI + script) |
| **Speed** | Faster for single images | Faster for batch (model already loaded) |
| **Dependencies** | Requires DA3 package | Only requires NumPy |
| **Use Case** | Quick single image processing | Batch processing or reuse existing NPZ |
| **Model Loading** | Loads model each time | No model loading needed |
| **Intermediate Files** | None | Requires NPZ file |

### When to Use Each Mode

**Use `--image` mode when:**
- Processing a single image quickly
- You want a one-command solution
- You don't need to save intermediate NPZ files
- You have DA3 package installed

**Use `--npz` mode when:**
- You've already run DA3 CLI and have NPZ files
- Processing large batches (model loaded once by DA3 CLI)
- You want to reuse existing NPZ files
- You don't have DA3 package installed (only need NumPy)

## ‚ùì Troubleshooting

### Error: DA3 API not available

**Problem:** When using `--image` mode, script reports "DA3 API not available".

**Solution:**
- Install Depth-Anything-3 package: `pip install -e .`
- Or use `--npz` mode instead (doesn't require DA3 package)
- Check that `depth_anything_3` module can be imported

### Error: NPZ file not found

**Problem:** The script cannot find the NPZ file.

**Solution:**
- Check that you've run DA3 CLI with `--export-format mini_npz`
- Verify the path to the NPZ file is correct
- The NPZ file is typically located at: `./output/exports/mini_npz/results.npz`

### Error: 'intrinsics' not found in NPZ file

**Problem:** The NPZ file doesn't contain intrinsics data.

**Solution:**
- Ensure you used `--export-format mini_npz` (or `npz`) when running DA3
- The `glb` format doesn't include separate intrinsics files
- Re-run DA3 with the correct export format:
  ```bash
  da3 image photo.jpg --export-dir ./output --export-format mini_npz
  ```

### Error: Image index out of range

**Problem:** The specified image index is greater than the number of images.

**Solution:**
- Check how many images are in the NPZ file
- Use `--image-index` with a valid index (0 to N-1)
- Or use `--batch` to extract all K-matrices

### K-Matrix values seem incorrect

**Problem:** The K-matrix values don't match expected camera parameters.

**Possible causes:**
- Image resolution mismatch (K-matrix is in pixels, depends on image size)
- Different processing resolution used in DA3
- Camera model differences

**Solution:**
- Verify the image dimensions match the expected resolution
- Check the `--process-res` parameter used in DA3
- K-matrix values are relative to the processed image size, not original size

## üîó Related Resources

- **DA3 CLI Documentation**: See `Usage_guide.md` for CLI command details
- **DA3 Python API**: See `docs/API.md` for Python API usage
- **K-Matrix Use Cases**: See Example 9 in `Usage_guide.md`

## üìù Notes

- The K-matrix is estimated automatically by DA3 during inference
- Values are in pixels and depend on the image resolution
- For best results, use images with good lighting and clear features
- The estimated K-matrix may vary slightly between images from the same camera
- For batch processing, consider averaging K-matrices for consistency
- Direct image processing (`--image`) loads the model each time, which takes a few seconds
- For multiple images, `--image-dir` mode loads the model once and reuses it (more efficient)

## üéØ Implementation Details

### Architecture

The script supports two processing modes:

1. **Direct Image Processing Mode** (`--image` / `--image-dir`):
   - Uses DA3 Python API directly
   - Loads model, processes image(s), extracts intrinsics
   - No intermediate files needed
   - One-command solution

2. **NPZ Extraction Mode** (`--npz`):
   - Extracts K-matrices from pre-generated NPZ files
   - Requires DA3 CLI to be run first
   - Faster for batch processing (no model loading)
   - Can reuse existing NPZ files

### Performance Considerations

**Direct Processing (`--image` mode):**
- ‚úÖ Faster for single images (no intermediate file I/O)
- ‚úÖ Simpler workflow (one command)
- ‚ö†Ô∏è Requires model loading (slower first run, ~5-10 seconds)
- ‚ö†Ô∏è Requires GPU/CPU resources
- ‚úÖ Model reused for batch processing (`--image-dir`)

**NPZ Extraction (`--npz` mode):**
- ‚úÖ Faster for batch processing (model already loaded by DA3 CLI)
- ‚úÖ Can reuse existing NPZ files
- ‚ö†Ô∏è Requires two-step process
- ‚ö†Ô∏è Creates intermediate files
- ‚úÖ No model loading needed (only NumPy required)

### Dependencies

**For `--image` mode:**
- Python 3.6+
- NumPy
- PyTorch
- Depth-Anything-3 package
- PIL (for image loading)

**For `--npz` mode:**
- Python 3.6+
- NumPy (only dependency needed)

---

**Last Updated**: Based on Depth-Anything-3 estimate_k_matrix.py script (with direct image processing support)
